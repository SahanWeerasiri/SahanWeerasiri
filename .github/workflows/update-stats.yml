name: GitHub Stats Dashboard
on:
    schedule:
        - cron: "0 0 * * *" # Daily at midnight UTC
    workflow_dispatch: # Manual trigger
    push: # Trigger on push
        branches:
            - main # Only main branch
        paths:
            - "scripts/**" # When script files change
            - ".github/workflows/**" # When workflow changes
            - "requirements.txt" # When dependencies change

jobs:
    generate-dashboard:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Get all history for proper git diff

            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Install Dependencies
              run: |
                  # Install wkhtmltoimage for Python imgkit
                  sudo apt-get update
                  sudo apt-get install -y wkhtmltopdf

                  # Install Python package
                  pip install imgkit

            - name: Generate Everything
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITHUB_USERNAME: ${{ github.repository_owner }}
              run: |
                  mkdir -p data/screenshots
                  echo "ðŸ“Š Fetching GitHub stats..."
                  node scripts/fetch-stats.js
                  echo "ðŸŽ¨ Generating HTML dashboard..."
                  node scripts/generate-html.js
                  echo "ðŸ“¸ Generating screenshots..."
                  python scripts/generate-screenshot.py

            - name: Check for Changes
              id: changes
              run: |
                  echo "Checking for changes in data/ directory..."
                  git add data/
                  if git diff --cached --quiet; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "ðŸ“­ No changes to commit"
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "ðŸ“¬ Changes detected, will commit"
                  fi

            - name: Commit and Push Changes
              if: steps.changes.outputs.has_changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git commit -m "ðŸ¤– Auto-update GitHub stats - $(date +'%Y-%m-%d %H:%M UTC')"
                  git push
